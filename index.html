<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compliance & Auditoria Interna</title>
    <!-- √çcones e Fontes -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #8B0000;
            --primary-light: #fff0f0;
            --secondary-color: #f8f9fa;
            --text-dark: #333;
            --text-light: #ffffff;
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 65px;
            --header-height: 50px;
            --toolbar-height: 50px;
            
            /* Cores Estilo Imagem Login */
            --login-bg: #f4f7f6;
            --input-bg: #eef3fb;
            --btn-red: #b71c1c;
            --border-color: #d1d5db;
            
            /* Cores Dev Mode */
            --dev-bg: #0a0a0a;
            --dev-surface: #141414;
            --dev-purple: #9d4edd;
            --dev-purple-glow: #c77dff;
            --dev-border: #3c096c;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #f0f2f5;
        }

        /* --- TELA DE LOGIN --- */
        #login-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--login-bg);
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 40px 40px;
            display: flex; justify-content: center; align-items: center; z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .login-card {
            background: white; width: 100%; max-width: 420px; padding: 35px 45px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            text-align: center; display: flex;
            flex-direction: column; gap: 25px; 
            border: 1px solid #e2e8f0;
            animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .login-title { font-size: 1.8rem; font-weight: 600; color: #374151; margin-bottom: 5px; }
        .login-form { display: flex; flex-direction: column; gap: 20px; }

        .input-group {
            display: flex; align-items: center; border: 1px solid var(--border-color);
            border-radius: 6px; overflow: hidden; background: var(--input-bg);
        }

        .input-group i.main-icon {
            padding: 12px 15px; color: #6b7280; background: #ffffff;
            border-right: 1px solid var(--border-color); min-width: 50px;
            display: flex; justify-content: center; font-size: 0.9rem;
        }

        .input-group input { border: none; background: transparent; padding: 12px 15px; flex: 1; font-size: 0.95rem; color: #4b5563; }
        .input-group input::placeholder { color: #9ca3af; }
        .toggle-password { padding: 0 15px; cursor: pointer; color: #9ca3af; font-size: 0.9rem; background: transparent; }

        .login-btn { 
            align-self: center; padding: 10px 30px; background-color: var(--btn-red); 
            color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; 
            display: flex; align-items: center; gap: 10px; font-size: 1.1rem; margin-top: 5px;
            transition: transform 0.1s, background 0.2s;
        }
        .login-btn:hover { background-color: #9b1616; transform: scale(1.02); }

        .login-error { color: #dc2626; font-size: 0.85rem; display: none; margin-top: -10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD --- */
        #dashboard-wrapper { display: none; flex-direction: column; height: 100%; width: 100%; transition: opacity 0.6s ease; opacity: 0; }

        header {
            background-color: var(--primary-color); color: var(--text-light); height: var(--header-height);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .sidebar-toggle-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; padding: 5px; border-radius: 4px; transition: background 0.2s; }
        .sidebar-toggle-btn:hover { background: rgba(255,255,255,0.1); }
        header h1 { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .user-info { font-size: 0.85rem; background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 4px; }
        .logout-btn { background: none; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        .main-container { display: flex; flex: 1; height: calc(100vh - var(--header-height)); overflow: hidden; }

        aside {
            width: var(--sidebar-width); background-color: white; border-right: 1px solid #e0e0e0;
            display: flex; flex-direction: column; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 10;
            overflow-y: auto; overflow-x: hidden;
        }
        body.sidebar-minimized aside { width: var(--sidebar-collapsed-width); }

        .nav-item {
            display: flex; align-items: center; padding: 14px 18px; color: #555; text-decoration: none;
            border-left: 4px solid transparent; cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .nav-item:hover { background-color: #f9f9f9; color: var(--primary-color); }
        .nav-item.active { background-color: var(--primary-light); border-left-color: var(--primary-color); color: var(--primary-color); font-weight: 700; }
        
        .nav-icon { 
            min-width: 30px; text-align: center; font-size: 1.1rem; flex-shrink: 0; 
            transition: color 0.3s ease;
        }
        
        body.sidebar-minimized .nav-icon { color: var(--primary-color); }
        .nav-item.active .nav-icon { color: var(--primary-color); }

        .nav-text { margin-left: 10px; font-size: 0.85rem; font-weight: 500; opacity: 1; transition: opacity 0.2s; }
        .nav-input { display: none; width: 100%; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; padding: 2px 5px; }
        
        body.sidebar-minimized .nav-text { opacity: 0; pointer-events: none; width: 0; margin: 0; }
        body.sidebar-minimized .nav-item { justify-content: center; padding: 14px 0; }
        
        body.dev-mode-active .nav-text { display: none; }
        body.dev-mode-active .nav-input { display: block; }

        .sidebar-footer { margin-top: auto; border-top: 1px solid #eee; padding: 10px 0; display: flex; flex-direction: column; }
        .dev-gear-btn { padding: 14px 18px; color: #999; cursor: pointer; display: flex; align-items: center; gap: 10px; border: none; background: none; width: 100%; }
        .dev-gear-btn:hover { color: var(--primary-color); }
        .save-modules-btn { display: none; padding: 8px; background: #2e7d32; color: white; border: none; border-radius: 4px; margin: 5px 15px; cursor: pointer; font-size: 0.75rem; font-weight: bold; }
        body.dev-mode-active .save-modules-btn { display: block; }

        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fff; position: relative; }

        .module-toolbar {
            height: var(--toolbar-height); background: var(--dev-bg); border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
            font-family: 'Consolas', monospace;
        }
        .file-select { padding: 6px; border: 1px solid var(--dev-border); border-radius: 4px; background-color: var(--dev-surface); color: var(--dev-purple-glow); }
        .action-btn { padding: 6px 12px; font-size: 0.8rem; border-radius: 4px; border: 1px solid var(--dev-border); cursor: pointer; background-color: var(--dev-surface); color: var(--dev-purple-glow); }
        .action-btn:hover { background-color: var(--dev-purple); color: #fff; }

        #notification {
            position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff;
            padding: 12px 24px; border-radius: 8px; font-size: 0.9rem; z-index: 10000;
            display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease;
        }

        #insight-bubble {
            position: absolute; bottom: 20px; right: 20px; width: 320px;
            background: white; border-top: 4px solid var(--primary-color);
            border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 15px; z-index: 50; display: none; transition: transform 0.3s ease;
        }
        #insight-bubble.visible { display: block; animation: fadeIn 0.5s ease-out; }
        #insight-bubble.hiding { animation: fadeOut 0.5s ease-in forwards; }
        .insight-category { font-size: 0.7rem; font-weight: 800; color: var(--primary-color); text-transform: uppercase; margin-bottom: 8px; display: block; }
        .insight-text { font-size: 0.85rem; color: #444; line-height: 1.4; padding-right: 20px; }
        .close-insight { position: absolute; top: 8px; right: 10px; background: none; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer; }

        body.role-user .dev-only { display: none !important; }
        body.role-user .module-toolbar { background: #f8f9fa; border-bottom: 1px solid #ddd; }

        .content-area { flex: 1; position: relative; overflow: hidden; display: flex; }
        #code-editor { flex: 1; border: none; padding: 20px; background: #1e1e1e; color: #d4d4d4; display: none; font-family: monospace; resize: none; }
        
        #preview-frame { 
            flex: 1; border: none; background: white; display: none; width: 100%; height: 100%; 
        }

        .empty-state {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #f9f9f9; color: #999;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body class="role-user">

    <!-- Login -->
    <div id="login-wrapper">
        <div class="login-card">
            <div class="login-title">Acesso ao sistema</div>
            <div class="login-form">
                <div class="input-group">
                    <i class="fas fa-user main-icon"></i>
                    <input type="text" id="login-user" placeholder="Digite seu Usu√°rio">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock main-icon"></i>
                    <input type="password" id="login-pass" placeholder="Digite sua Senha" onkeypress="if(event.key === 'Enter') attemptLogin()">
                    <i class="fas fa-eye-slash toggle-password" onclick="togglePasswordVisibility()"></i>
                </div>
                <div class="login-error" id="login-error">Credenciais inv√°lidas. Verifique seu usu√°rio e senha.</div>
                <button class="login-btn" onclick="attemptLogin()">
                    <i class="fas fa-right-to-bracket"></i> Entrar
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-wrapper">
        <header>
            <div class="header-left">
                <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Maximizar/Minimizar Menu">
                    <i class="fas fa-bars"></i>
                </button>
                <h1><i class="fas fa-shield-halved"></i> Compliance & Auditoria Interna</h1>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span id="user-display" class="user-info"></span>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </header>

        <div class="main-container">
            <aside id="sidebar">
                <div id="nav-container">
                    <!-- Din√¢mico -->
                </div>
                
                <div class="sidebar-footer dev-only">
                    <button class="save-modules-btn" onclick="saveModuleLabels()">
                        <i class="fas fa-check"></i> Salvar Altera√ß√µes
                    </button>
                    <button class="dev-gear-btn" onclick="toggleDevMode()" title="Editar Nomes dos M√≥dulos">
                        <i class="fas fa-cog nav-icon"></i><span class="nav-text">Gerenciar M√≥dulos</span>
                    </button>
                </div>
            </aside>

            <main>
                <div class="module-toolbar" id="toolbar">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <select id="file-selector" class="file-select" onchange="changeFile()">
                            <option value="">Selecione...</option>
                        </select>
                        <button class="action-btn dev-only" onclick="createNewFile()">Novo Arquivo</button>
                        <button class="action-btn dev-only" onclick="saveFile()">Salvar Altera√ß√µes</button>
                        <button class="action-btn dev-only" onclick="runCode()">Executar Agora</button>
                    </div>
                    <div class="dev-only" style="display:flex; gap:5px;">
                        <button class="action-btn" onclick="setView('edit')">C√≥digo</button>
                        <button class="action-btn" onclick="setView('run')">Visual</button>
                    </div>
                </div>

                <div class="content-area">
                    <div id="empty-state" class="empty-state">
                        <i class="fas fa-folder-open" style="font-size:3rem; margin-bottom:10px;"></i>
                        <p>Selecione um m√≥dulo no menu lateral para iniciar.</p>
                    </div>
                    <textarea id="code-editor" spellcheck="false"></textarea>
                    <!-- SANDBOX COM PERMISS√ÉO DE DOWNLOADS E POPUPS -->
                    <iframe id="preview-frame" sandbox="allow-scripts allow-modals allow-forms allow-same-origin allow-downloads allow-popups"></iframe>
                </div>

                <div id="insight-bubble">
                    <button class="close-insight" onclick="closeInsights()" title="Fechar insights">&times;</button>
                    <span id="insight-cat" class="insight-category"></span>
                    <div id="insight-content" class="insight-text"></div>
                </div>
            </main>
        </div>
    </div>

    <div id="notification"></div>

<script>
    /**
     * C√ìDIGO DO RANKING DE LOJAS (PR√â-CARREGADO)
     */
    const rankingTemplate = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking de Invent√°rios - Auditoria de Compliance</title>
    
    <!-- Importa√ß√£o da Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { red: { 900: '#7f1d1d', 950: '#450a0a' } }
                }
            }
        }
    <\/script>
    
    <!-- Firebase SDK Compat (Est√°vel para scripts Babel √∫nicos) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"><\/script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"><\/script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"><\/script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
    
    <!-- PapaParse para CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"><\/script>
    
    <!-- jsPDF & html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"><\/script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"><\/script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"><\/script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tabular-nums { font-variant-numeric: tabular-nums; letter-spacing: -0.01em; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(229, 231, 235, 1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .table-container { overflow-x: auto; max-width: 100%; scrollbar-width: thin; }
        th { white-space: nowrap; padding: 10px 6px; font-size: 0.65rem; cursor: pointer; user-select: none; font-weight: 700; text-transform: uppercase; }
        td { white-space: nowrap; padding: 6px 4px; border-bottom: 1px solid #f3f4f6; font-size: 0.75rem; }
        .battery-container { width: 100%; height: 44px; background: #e5e7eb; border: 2px solid #374151; border-radius: 6px; position: relative; padding: 3px; }
        .battery-fill { height: 100%; border-radius: 3px; transition: width 1s ease-in-out; display: flex; align-items: center; justify-content: center; position: relative; min-width: 30px; }
        .pdf-export-mode .glass-panel { overflow: visible !important; width: 100% !important; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 600; z-index: 1000; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Regionais (Fonte da Verdade) ---
        const STORE_REGIONALS = {
            "LOJA TERESINA 5": "JULIETA MATOS", "LOJA JOAO PESSOA 1": "JULIETA MATOS", "LOJA PICOS": "JULIETA MATOS",
            "LOJA JOAO PESSOA 2": "JULIETA MATOS", "LOJA SANTA RITA": "JULIETA MATOS", "LOJA TERESINA 4": "JULIETA MATOS",
            "LOJA CAMPINA GRANDE": "JULIETA MATOS", "LOJA NATAL 3": "JULIETA MATOS", "LOJA FORTALEZA 1": "JULIETA MATOS",
            "LOJA NATAL 1": "JULIETA MATOS", "LOJA TERESINA 3": "JULIETA MATOS", "LOJA BR": "JULIETA MATOS",
            "LOJA JOAO PESSOA 4": "JULIETA MATOS", "LOJA PARNAMIRIM": "JULIETA MATOS", "LOJA JOAO PESSOA 3": "JULIETA MATOS",
            "LOJA MOSSORO": "JULIETA MATOS", "LOJA PATOS": "JULIETA MATOS", "LOJA FORTALEZA 5": "JULIETA MATOS",
            "LOJA PARNAIBA": "JULIETA MATOS", "LOJA DIAMANTES CENTRO": "JULIETA MATOS",
            "LOJA ACAILANDIA": "ELITIANE GOMES", "LOJA BELEM 1": "ELITIANE GOMES", "LOJA BELEM 2": "ELITIANE GOMES",
            "LOJA PARAUAPEBAS": "ELITIANE GOMES", "LOJA SAO LUIS 4": "ELITIANE GOMES", "LOJA PRESIDENTE DUTRA": "ELITIANE GOMES",
            "LOJA PINHEIRO": "ELITIANE GOMES", "LOJA BACABAL 1": "ELITIANE GOMES", "LOJA CASTANHAL": "ELITIANE GOMES",
            "LOJA PEDREIRAS": "ELITIANE GOMES", "LOJA SANTA INES": "ELITIANE GOMES", "LOJA MARABA": "ELITIANE GOMES",
            "LOJA SAO LUIS 3": "ELITIANE GOMES", "LOJA SAO LUIS 2": "ELITIANE GOMES", "LOJA IMPERATRIZ": "ELITIANE GOMES",
            "LOJA SAO LUIS 1": "ELITIANE GOMES",
            "LOJA BRASILIA": "LUCIANA OLIVEIRA", "LOJA FEIRA DE SANTANA 1": "LUCIANA OLIVEIRA", "LOJA CARUARU": "LUCIANA OLIVEIRA",
            "LOJA GARANHUNS": "LUCIANA OLIVEIRA", "LOJA PAULO AFONSO 1": "LUCIANA OLIVEIRA", "LOJA ARACAJU 3": "LUCIANA OLIVEIRA",
            "LOJA MACEIO 2": "LUCIANA OLIVEIRA", "LOJA ARACAJU 1": "LUCIANA OLIVEIRA", "LOJA MACEIO 3": "LUCIANA OLIVEIRA",
            "LOJA ALAGOINHAS": "LUCIANA OLIVEIRA", "LOJA ARAPIRACA 2": "LUCIANA OLIVEIRA", "LOJA ITABAIANA": "LUCIANA OLIVEIRA",
            "LOJA OUTRAN": "LUCIANA OLIVEIRA", "LOJA ARAPIRACA 1": "LUCIANA OLIVEIRA",
            "LOJA TELEDIGITAL": "COMERCIAL", "LOJA TELEVENDAS 8": "COMERCIAL", "ECOMMERCE / VENDA VAREJO": "COMERCIAL"
        };

        const getRegional = (storeName) => {
            const norm = storeName ? storeName.trim().toUpperCase() : "";
            return STORE_REGIONALS[norm] || "Regional n√£o definida";
        };

        // --- Helpers ---
        const formatBRL = (v) => {
            if (v === null || v === undefined || isNaN(v)) return "R$ 0,00";
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v).replace('R$', 'R$ ');
        };

        const parseBRL = (s) => {
            if (typeof s === 'number') return s;
            if (!s) return 0;
            const clean = s.toString().replace(/[R$\\s.]/g, '').replace(',', '.');
            const num = parseFloat(clean);
            return isNaN(num) ? 0 : num;
        };

        const formatDateDisplay = (iso) => {
            if (!iso) return "-";
            const p = iso.split('-');
            return p.length === 3 ? \`\${p[2]}/\${p[1]}/\${p[0]}\` : iso;
        };

        const LucideIcon = ({ name, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) i.setAttribute('class', className);
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name, className]);
            return <span ref={ref} className="inline-flex"></span>;
        };

        const MoneyInput = ({ value, onChange, className }) => {
            const [display, setDisplay] = useState(formatBRL(value));
            useEffect(() => { setDisplay(formatBRL(value)); }, [value]);
            return (
                <input
                    type="text"
                    value={display}
                    onChange={e => setDisplay(e.target.value)}
                    onBlur={() => {
                        const num = parseBRL(display);
                        onChange(num);
                        setDisplay(formatBRL(num));
                    }}
                    className={\`\${className} tabular-nums text-right outline-none\`}
                />
            );
        };

        // --- Dashboard Component ---
        const Dashboard = () => {
            const [data, setData] = useState([]);
            const [user, setUser] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [sortConfig, setSortConfig] = useState({ key: 'data', direction: 'desc' });
            const [filterYear, setFilterYear] = useState('');
            const [filterMonth, setFilterMonth] = useState('TODOS');
            const [storeSearch, setStoreSearch] = useState("");
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);

            const config = window.__firebase_config ? JSON.parse(window.__firebase_config) : {};
            const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'auditoria-compliance';

            if (!firebase.apps.length) firebase.initializeApp(config);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // Auto-login e Load (Regras Firestore)
            useEffect(() => {
                const init = async () => {
                    try {
                        if (window.__initial_auth_token) await auth.signInWithCustomToken(window.__initial_auth_token);
                        else await auth.signInAnonymously();
                    } catch (e) { console.error("Auth Error", e); }
                };
                init();
                const unsub = auth.onAuthStateChanged(async (u) => {
                    setUser(u);
                    if (u) {
                        try {
                            const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lojas').get();
                            const loaded = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            if (loaded.length > 0) setData(loaded);
                        } catch (e) { console.error(e); }
                        finally { setIsLoading(false); }
                    }
                });
                return () => unsub();
            }, []);

            const showToast = (msg, type = 'success') => {
                setToast({ msg, type });
                setTimeout(() => setToast(null), 3000);
            };

            const handleSaveToCloud = async () => {
                if (!user || data.length === 0) return;
                setIsSaving(true);
                try {
                    const batch = db.batch();
                    const coll = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lojas');
                    data.forEach(item => {
                        const ref = coll.doc(item.id.toString());
                        batch.set(ref, item);
                    });
                    await batch.commit();
                    showToast("Dados guardados com sucesso!");
                } catch (e) { showToast("Erro ao guardar", "error"); }
                finally { setIsSaving(false); }
            };

            const handleFileUpload = (ev) => {
                const file = ev.target.files[0];
                if (!file) return;
                Papa.parse(file, {
                    header: true, skipEmptyLines: 'greedy', 
                    complete: (res) => {
                        const f = res.meta.fields || [];
                        const newData = res.data.filter(r => r[f[0]]).map((r, idx) => ({
                            id: Date.now() + idx,
                            emp: parseBRL(r[f[0]]),
                            nmLoja: r[f[1]] || "",
                            loja: r[f[2]] || "Loja",
                            data: (s => { 
                                if(!s) return new Date().toISOString().split('T')[0]; 
                                const p = s.toString().trim().split('/'); 
                                return p.length === 3 ? \`\${p[2]}-\${p[1].padStart(2,'0')}-\${p[0].padStart(2,'0')}\` : s; 
                            })(r[f[3]]),
                            balanco: parseBRL(r[f[4]]),
                            qtFalta: parseBRL(r[f[5]]),
                            vlFalta: parseBRL(r[f[6]]),
                            qtSobra: parseBRL(r[f[7]]),
                            vlSobra: parseBRL(r[f[8]]),
                            vlDesvioLiq: parseBRL(r[f[9]]), // Coluna J
                            vlDesvioReal: parseBRL(r[f[10]]),
                            vlEstoque: parseBRL(r[f[11]]),
                            percDesvioLiq: parseBRL(r[f[12]]),
                            acuracidade: 100 - parseBRL(r[f[13]]),
                            imposto: parseBRL(r[f[14]]),
                        }));
                        setData(prev => [...prev, ...newData]);
                        showToast(\`\${newData.length} registos carregados.\`);
                    }
                });
                ev.target.value = null;
            };

            const filteredData = useMemo(() => {
                return data.filter(item => {
                    const [y, m] = item.data.split('-');
                    const yM = !filterYear || filterYear === 'TODOS' || y === filterYear;
                    const mM = !filterMonth || filterMonth === 'TODOS' || m === filterMonth;
                    return yM && mM;
                });
            }, [data, filterYear, filterMonth]);

            const stats = useMemo(() => {
                if (filteredData.length === 0) return { fs: 0, est: 0, acc: 0, imp: 0, count: 0, perc: 0 };
                const f = filteredData.reduce((acc, i) => acc + (i.vlFalta || 0), 0);
                const s = filteredData.reduce((acc, i) => acc + (i.vlSobra || 0), 0);
                const e = filteredData.reduce((acc, i) => acc + (i.vlEstoque || 0), 0);
                const im = filteredData.reduce((acc, i) => acc + (i.imposto || 0), 0);
                const ac = filteredData.reduce((acc, i) => acc + (i.acuracidade || 0), 0) / filteredData.length;
                const unique = new Set(filteredData.map(i => i.loja)).size;
                return { fs: f + s, est: e, acc: ac, imp: im, count: unique, perc: Math.min((unique / 50) * 100, 100) };
            }, [filteredData]);

            const rankings = useMemo(() => {
                const regMap = {};
                filteredData.forEach(i => {
                    const r = getRegional(i.loja);
                    if (!regMap[r]) regMap[r] = { sum: 0, count: 0 };
                    regMap[r].sum += i.acuracidade;
                    regMap[r].count += 1;
                });
                const regions = Object.keys(regMap).map(k => ({ name: k, avg: regMap[k].sum / regMap[k].count }))
                    .sort((a,b) => b.avg - a.avg);

                const stores = [...filteredData].sort((a,b) => b.acuracidade - a.acuracidade);

                return {
                    best: stores.slice(0, 3),
                    worst: [...stores].reverse().slice(0, 3),
                    coord: regions.slice(0, 3)
                };
            }, [filteredData]);

            const sortedData = useMemo(() => {
                let items = [...filteredData];
                if (sortConfig.key) {
                    items.sort((a, b) => {
                        let aV = a[sortConfig.key];
                        let bV = b[sortConfig.key];
                        if (typeof aV === 'number') return sortConfig.direction === 'asc' ? aV - bV : bV - aV;
                        return sortConfig.direction === 'asc' ? String(aV).localeCompare(String(bV)) : String(bV).localeCompare(String(aV));
                    });
                }
                return items;
            }, [filteredData, sortConfig]);

            if (isLoading) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50">
                    <div className="text-center">
                        <div className="w-12 h-12 border-4 border-red-900 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                        <p className="text-gray-500 font-bold uppercase text-[10px] tracking-widest">Sincronizando com a nuvem...</p>
                    </div>
                </div>
            );

            return (
                <div id="dashboard-content" className="min-h-screen p-6 pb-20 bg-gray-50 font-sans">
                    {toast && <div className={\`toast \${toast.type === 'success' ? 'bg-green-600' : 'bg-red-600 shadow-lg'}\`}>{toast.msg}</div>}

                    {/* Header */}
                    <div className="bg-red-900 text-white p-6 rounded-xl shadow-lg flex justify-between items-center mb-8 relative overflow-hidden border-b-4 border-red-950">
                        <div className="relative z-10">
                            <h1 className="text-2xl font-black tracking-tight">Ranking de Invent√°rios</h1>
                            <p className="text-red-100 text-[10px] font-medium uppercase tracking-widest opacity-80">Gest√£o de Auditoria & Compliance</p>
                        </div>
                        <div className="relative z-10" data-html2canvas-ignore="true">
                            <button onClick={async () => {
                                setIsGeneratingPdf(true);
                                await new Promise(r => setTimeout(r, 600));
                                const canvas = await html2canvas(document.getElementById('dashboard-content'), { scale: 2 });
                                const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
                                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 297, (canvas.height * 297) / canvas.width);
                                pdf.save('Relatorio_Auditoria.pdf');
                                setIsGeneratingPdf(false);
                            }} className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
                                <LucideIcon name="file-down" className="w-4 h-4" /> {isGeneratingPdf ? 'Gerando...' : 'Exportar PDF'}
                            </button>
                        </div>
                    </div>

                    {/* KPIs */}
                    <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                        <div className="bg-white p-4 rounded-xl shadow border-2 border-slate-700 flex flex-col justify-between">
                            <div className="flex justify-between items-start mb-2">
                                <p className="text-slate-500 text-[9px] font-black uppercase">LOJAS AUDITADAS</p>
                                <div className="flex gap-1" data-html2canvas-ignore="true">
                                    <select value={filterYear} onChange={e => setFilterYear(e.target.value)} className="text-[9px] font-bold border rounded">
                                        <option value="TODOS">ANO</option>
                                        {[...new Set(data.map(d => d.data.split('-')[0]))].sort().reverse().map(y => <option key={y} value={y}>{y}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div className="battery-container">
                                <div className="battery-fill" style={{ width: \`\${stats.perc}%\`, backgroundColor: stats.perc < 50 ? '#dc2626' : '#16a34a' }}>
                                    <span className="text-white text-xs font-black">{stats.perc.toFixed(1)}%</span>
                                </div>
                            </div>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-blue-600">
                            <p className="text-blue-600 text-[9px] font-black uppercase">FALTA + SOBRA</p>
                            <p className="text-lg font-bold tabular-nums">{formatBRL(stats.fs)}</p>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-indigo-600">
                            <p className="text-indigo-600 text-[9px] font-black uppercase">ESTOQUE AUDITADO</p>
                            <p className="text-lg font-bold tabular-nums">{formatBRL(stats.est)}</p>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-green-600">
                            <p className="text-green-600 text-[9px] font-black uppercase">ACURACIDADE M√âDIA</p>
                            <p className="text-lg font-bold tabular-nums">{stats.acc.toFixed(2)}%</p>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-red-600">
                            <p className="text-red-600 text-[9px] font-black uppercase">IMPOSTO ESTIMADO</p>
                            <p className="text-lg font-bold tabular-nums">{formatBRL(stats.imp)}</p>
                        </div>
                    </div>

                    {/* Rankings */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div className="glass-panel p-4 rounded-xl border-t-4 border-green-500">
                            <h3 className="text-[10px] font-black text-gray-400 mb-3 flex items-center gap-2"><LucideIcon name="trophy" className="w-3 h-3 text-yellow-500" /> MELHORES LOJAS</h3>
                            {rankings.best.map((r, i) => (
                                <div key={i} className="flex justify-between p-2 bg-green-50 rounded mb-1 text-[10px] font-bold">
                                    <span className="truncate pr-2">{r.loja}</span>
                                    <span className="text-green-700">{r.acuracidade.toFixed(2)}%</span>
                                </div>
                            ))}
                        </div>
                        <div className="glass-panel p-4 rounded-xl border-t-4 border-blue-500">
                            <h3 className="text-[10px] font-black text-gray-400 mb-3 flex items-center gap-2"><LucideIcon name="users" className="w-3 h-3 text-blue-500" /> COORDENA√á√ïES</h3>
                            {rankings.coord.map((r, i) => (
                                <div key={i} className="flex justify-between p-2 bg-blue-50 rounded mb-1 text-[10px] font-bold">
                                    <span className="truncate pr-2 uppercase">{r.name}</span>
                                    <span className="text-blue-700">{r.avg.toFixed(2)}%</span>
                                </div>
                            ))}
                        </div>
                        <div className="glass-panel p-4 rounded-xl border-t-4 border-red-500">
                            <h3 className="text-[10px] font-black text-gray-400 mb-3 flex items-center gap-2"><LucideIcon name="alert-circle" className="w-3 h-3 text-red-500" /> PIORES LOJAS</h3>
                            {rankings.worst.map((r, i) => (
                                <div key={i} className="flex justify-between p-2 bg-red-50 rounded mb-1 text-[10px] font-bold">
                                    <span className="truncate pr-2">{r.loja}</span>
                                    <span className="text-red-700">{r.acuracidade.toFixed(2)}%</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Controlos */}
                    <div className="flex flex-wrap gap-2 justify-end mb-4" data-html2canvas-ignore="true">
                        <div className="flex items-center bg-white px-3 rounded-lg border shadow-sm">
                            <LucideIcon name="search" className="w-4 h-4 text-gray-300" />
                            <input type="text" placeholder="Buscar loja..." className="text-xs p-2 outline-none w-40" value={storeSearch} onChange={e => setStoreSearch(e.target.value)} />
                        </div>
                        <label className="bg-red-900 hover:bg-red-800 text-white font-bold px-4 py-2 rounded-lg cursor-pointer text-[10px] flex items-center gap-2 shadow h-[38px] uppercase tracking-wider">
                            <LucideIcon name="plus-circle" className="w-4 h-4" /> Importar CSV
                            <input type="file" className="hidden" onChange={handleFileUpload} />
                        </label>
                        <button onClick={handleSaveToCloud} disabled={isSaving || data.length === 0} className={\`bg-green-700 hover:bg-green-800 text-white font-bold px-4 py-2 rounded-lg text-[10px] flex items-center gap-2 shadow h-[38px] uppercase tracking-wider transition \${isSaving ? 'opacity-50 cursor-wait' : ''}\`}>
                            <LucideIcon name={isSaving ? "loader" : "save"} className={\`w-4 h-4 \${isSaving ? 'animate-spin' : ''}\`} />
                            {isSaving ? 'Guardando...' : 'Salvar'}
                        </button>
                    </div>

                    {/* Tabela Anal√≠tica */}
                    <div className="glass-panel rounded-xl overflow-hidden shadow-xl">
                        <div className="table-container">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-400 border-b">
                                    <tr>
                                        {['emp', 'nmLoja', 'loja', 'data', 'balanco'].map(k => (
                                            <th key={k} onClick={() => setSortConfig({ key: k, direction: sortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                {k === 'balanco' ? 'NB' : k}
                                            </th>
                                        ))}
                                        <th className="text-right">QT.FALTA</th>
                                        <th className="text-right">VL.FALTA</th>
                                        <th className="text-right">QT.SOBRA</th>
                                        <th className="text-right">VL.SOBRA</th>
                                        <th className="text-right text-indigo-700">VLDesv. Liq.</th>
                                        <th className="text-right">VL.DESVIO REAL</th>
                                        <th className="text-right">% DESVIO LIQ</th>
                                        <th className="text-right">VL.ESTOQUE</th>
                                        <th className="text-center">ACURACIDADE</th>
                                        <th className="text-right">IMPOSTO</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedData.filter(i => !storeSearch || i.loja.toUpperCase().includes(storeSearch.toUpperCase())).map(item => (
                                        <tr key={item.id} className="hover:bg-blue-50 transition border-b border-gray-50">
                                            <td className="p-2 font-bold text-gray-400 tabular-nums">{item.emp}</td>
                                            <td className="font-black text-blue-600 uppercase">{item.nmLoja}</td>
                                            <td className="font-bold text-gray-800">{item.loja}</td>
                                            <td className="text-gray-400 tabular-nums">{formatDateDisplay(item.data)}</td>
                                            <td className="tabular-nums">{item.balanco}</td>
                                            <td className="text-right tabular-nums">{item.qtFalta}</td>
                                            <td className="bg-red-50/30">
                                                <MoneyInput value={item.vlFalta} onChange={v => setData(data.map(d => d.id === item.id ? { ...d, vlFalta: v } : d))} className="text-red-600 font-bold" />
                                            </td>
                                            <td className="text-right tabular-nums">{item.qtSobra}</td>
                                            <td className="bg-green-50/30">
                                                <MoneyInput value={item.vlSobra} onChange={v => setData(data.map(d => d.id === item.id ? { ...d, vlSobra: v } : d))} className="text-green-600 font-bold" />
                                            </td>
                                            <td className="text-right font-black text-indigo-800 tabular-nums">{formatBRL(item.vlDesvioLiq)}</td>
                                            <td className="text-right font-medium tabular-nums">{formatBRL(item.vlDesvioReal)}</td>
                                            <td className="text-right text-blue-800 font-bold tabular-nums">{item.percDesvioLiq}%</td>
                                            <td className="text-right tabular-nums">{formatBRL(item.vlEstoque)}</td>
                                            <td className="text-center">
                                                <span className={\`px-2 py-1 rounded font-black tabular-nums \${item.acuracidade > 97.9 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}\`}>
                                                    {item.acuracidade.toFixed(2)}%
                                                </span>
                                            </td>
                                            <td className="text-right font-bold text-red-700 tabular-nums">{formatBRL(item.imposto)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    <\/script>
</body>
</html>`;

    /**
     * CONFIGURA√á√ÉO DE M√ìDULOS
     */
    let modulesConfig = [
        { id: 'pops', icon: 'fa-file-contract', label: 'Controle de Cria√ß√£o de POPs' },
        { id: 'laudo', icon: 'fa-scale-balanced', label: 'Laudo 26 Auditoria e Compliance' },
        { id: 'ranking', icon: 'fa-trophy', label: 'Ranking Lojas Painel' },
        { id: 'checklist', icon: 'fa-list-check', label: 'Check List Lojas' },
        { id: 'inventario', icon: 'fa-calendar-days', label: 'Calend√°rio de Invent√°rios' },
        { id: 'portaria', icon: 'fa-id-card-clip', label: 'Sistema de Controle de Portaria' },
        { id: 'organograma', icon: 'fa-sitemap', label: 'Organograma e Fluxograma' },
        { id: 'notificacoes', icon: 'fa-bell', label: 'Notifica√ß√µes' },
        { id: 'paralegal', icon: 'fa-gavel', label: 'Paralegal' }
    ];

    let currentModule = null;
    let currentFileId = null;
    let currentView = 'run';
    let insightTimer = null;

    const users = [
        {u:'Compliance', p:'1307', role:'admin'}, 
        {u:'Tiago', p:'1307', role:'admin'},
        {u:'Nathalia', p:'1234', role:'user'} 
    ];

    const complianceInsights = [
        { cat: "üîé COMPLIANCE", text: "Compliance n√£o √© apenas jur√≠dico: √â um sistema estruturado de preven√ß√£o de riscos regulat√≥rios, reputacionais e operacionais." },
        { cat: "üèõ GOVERNAN√áA", text: "Governan√ßa ‚â† Gest√£o: Governan√ßa define direcionamento e supervis√£o. Gest√£o executa a estrat√©gia." },
        { cat: "üå± ESG", text: "ESG n√£o √© filantropia: √â gest√£o de risco ambiental, social e reputacional com impacto financeiro direto." },
        { cat: "üìä AUDITORIA", text: "Auditoria n√£o √© ca√ßa-erro: √â ferramenta de melhoria de controles e efici√™ncia operacional." },
        { cat: "‚öôÔ∏è PROCESSOS", text: "SLA e Governan√ßa: Tempo pactuado e mensurado aumenta a previsibilidade organizacional." },
        { cat: "üìà DADO RELEVANTE", text: "Empresas perdem, em m√©dia, 5% da receita anual com fraudes internas (Fonte: ACFE)." }
    ];

    /**
     * NAVEGA√á√ÉO E UI
     */
    function renderSidebar() {
        const container = document.getElementById('nav-container');
        container.innerHTML = '';
        modulesConfig.forEach(mod => {
            const div = document.createElement('div');
            div.className = `nav-item ${currentModule === mod.id ? 'active' : ''}`;
            div.id = `nav-${mod.id}`;
            div.onclick = () => selectModule(mod.id);
            div.title = mod.label;
            
            div.innerHTML = `
                <i class="fas ${mod.icon} nav-icon"></i>
                <span class="nav-text">${mod.label}</span>
                <input class="nav-input" value="${mod.label}" data-mod="${mod.id}" onclick="event.stopPropagation()">
            `;
            container.appendChild(div);
        });
    }

    function toggleSidebar() { document.body.classList.toggle('sidebar-minimized'); }
    
    function toggleDevMode() { 
        document.body.classList.toggle('dev-mode-active');
        if(document.body.classList.contains('dev-mode-active')) showNotification("Modo de edi√ß√£o de nomes ativado.");
    }

    function saveModuleLabels() {
        const inputs = document.querySelectorAll('.nav-input');
        inputs.forEach(input => {
            const modId = input.dataset.mod;
            const mod = modulesConfig.find(m => m.id === modId);
            if(mod) mod.label = input.value;
        });
        localStorage.setItem('compliance_modules_config', JSON.stringify(modulesConfig));
        document.body.classList.remove('dev-mode-active');
        renderSidebar();
        showNotification("Nomes dos m√≥dulos salvos com sucesso!");
    }

    function togglePasswordVisibility() {
        const passInput = document.getElementById('login-pass');
        const eyeIcon = document.querySelector('.toggle-password');
        if (passInput.type === 'password') {
            passInput.type = 'text';
            eyeIcon.classList.replace('fa-eye-slash', 'fa-eye');
        } else {
            passInput.type = 'password';
            eyeIcon.classList.replace('fa-eye', 'fa-eye-slash');
        }
    }

    /**
     * LOGIN
     */
    function attemptLogin() {
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value.trim();
        const valid = users.find(x => x.u.toLowerCase() === u.toLowerCase() && x.p === p);
        
        if(valid) {
            document.getElementById('login-wrapper').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-wrapper').style.display = 'none';
                document.getElementById('dashboard-wrapper').style.display = 'flex';
                setTimeout(() => { document.getElementById('dashboard-wrapper').style.opacity = '1'; }, 50);
                document.getElementById('user-display').innerText = `Ol√°, ${valid.u}`;
                document.body.className = 'role-' + valid.role;
                initSystem();
                startInsights();
            }, 500);
        } else {
            document.getElementById('login-error').style.display = 'block';
            const card = document.querySelector('.login-card');
            card.style.animation = 'none';
            void card.offsetWidth;
            card.style.animation = 'shake 0.4s';
        }
    }

    function logout() {
        if (insightTimer) clearInterval(insightTimer);
        location.reload(); 
    }

    /**
     * DADOS
     */
    const DB_KEY = 'compliance_master_db_v2'; 
    let db = {};

    function initSystem() {
        // Carregar labels customizados
        const savedConfig = localStorage.getItem('compliance_modules_config');
        if (savedConfig) modulesConfig = JSON.parse(savedConfig);

        const savedData = localStorage.getItem(DB_KEY);
        if(savedData) db = JSON.parse(savedData);
        
        modulesConfig.forEach(mod => {
            if(!db[mod.id]) db[mod.id] = [];
            if(db[mod.id].length === 0) {
                // Se for o ranking, usa o template customizado, sen√£o usa o padr√£o
                const initialCode = mod.id === 'ranking' ? rankingTemplate : getDefaultTemplate(mod.label);
                db[mod.id].push({id: Date.now().toString(), name: 'Documento Inicial', code: initialCode});
            }
        });
        
        renderSidebar();
    }

    function selectModule(modId) {
        if(document.body.classList.contains('dev-mode-active')) return;
        currentModule = modId;
        renderSidebar();
        updateFileSelector();
        const files = db[currentModule] || [];
        if (files.length > 0) {
            document.getElementById('file-selector').value = files[0].id;
            changeFile();
        } else {
            showEmptyState();
        }
    }

    function updateFileSelector() {
        const sel = document.getElementById('file-selector');
        sel.innerHTML = '<option value="">Selecione um Arquivo...</option>';
        (db[currentModule] || []).forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.id; opt.innerText = f.name;
            sel.appendChild(opt);
        });
    }

    function changeFile() {
        const id = document.getElementById('file-selector').value;
        if(!id) return showEmptyState();
        currentFileId = id;
        const file = db[currentModule].find(f => f.id === id);
        if (file) {
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('code-editor').value = file.code;
            runCode();
            setView(document.body.classList.contains('role-user') ? 'run' : currentView);
        }
    }

    /**
     * EXECU√á√ÉO DE C√ìDIGO (SANDBOXED)
     */
    function runCode() {
        const code = document.getElementById('code-editor').value;
        const frame = document.getElementById('preview-frame');
        
        // Injetar vari√°veis globais do contexto pai para o iframe
        const injection = `
            <script>
                window.__firebase_config = '${window.__firebase_config || ""}';
                window.__app_id = '${window.__app_id || "auditoria-compliance"}';
                window.__initial_auth_token = '${window.__initial_auth_token || ""}';
            <\/script>
        `;
        
        let fullCode = code;
        
        // Insere a inje√ß√£o no local correto
        if (code.includes('<head>')) {
            fullCode = code.replace('<head>', '<head>' + injection);
        } else if (code.includes('<html>')) {
            fullCode = code.replace('<html>', '<html><head>' + injection + '</head>');
        } else {
            fullCode = `<!DOCTYPE html><html><head>${injection}</head><body>${code}</body></html>`;
        }

        frame.srcdoc = fullCode;
    }

    function setView(mode) {
        currentView = mode;
        document.getElementById('code-editor').style.display = mode === 'edit' ? 'block' : 'none';
        document.getElementById('preview-frame').style.display = mode === 'run' ? 'block' : 'none';
    }

    function saveFile() {
        if(!currentFileId || !currentModule) return;
        const code = document.getElementById('code-editor').value;
        const file = db[currentModule].find(f => f.id === currentFileId);
        if (file) {
            file.code = code;
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            showNotification("M√≥dulo atualizado com sucesso.");
        }
    }

    function createNewFile() {
        if(!currentModule) return alert("Selecione um m√≥dulo.");
        const name = prompt("Nome do arquivo:");
        if(!name) return;
        const newId = Date.now().toString();
        // Se for ranking, usa o template customizado, sen√£o usa o padr√£o
        const code = currentModule === 'ranking' ? rankingTemplate : getDefaultTemplate(modulesConfig.find(m => m.id === currentModule).label);
        
        db[currentModule].push({ id: newId, name: name, code: code });
        localStorage.setItem(DB_KEY, JSON.stringify(db));
        updateFileSelector();
        document.getElementById('file-selector').value = newId;
        changeFile();
    }

    /**
     * TEMPLATES PADR√ÉO
     */
    function getDefaultTemplate(modName) {
        return `<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${modName}</title>
    <!-- Bibliotecas Padr√£o para PDF e UI -->
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"><\/script>
    <style>
        body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .export-btn { transition: all 0.2s; }
        .export-btn:hover { transform: scale(1.05); }
    </style>
</head>
<body class="p-8">
    <div id="content-to-export" class="max-w-4xl mx-auto bg-white p-10 rounded-xl shadow-lg border border-gray-100">
        <div class="flex justify-between items-center mb-10 border-b pb-5">
            <div>
                <h1 class="text-2xl font-bold text-red-900">${modName}</h1>
                <p class="text-sm text-gray-500">Documento Gerado via Painel Compliance</p>
            </div>
            <i class="fas fa-shield-halved text-4xl text-red-800"></i>
        </div>
        
        <div class="space-y-6 text-gray-700">
            <p>Este ambiente √© <strong>execut√°vel de forma independente</strong>. Voc√™ pode adicionar formul√°rios, tabelas e bot√µes de exporta√ß√£o.</p>
            <div class="p-4 bg-gray-50 border-l-4 border-red-800 italic">
                "A auditoria preventiva custa menos que a atua√ß√£o corretiva."
            </div>
            <p>Clique no bot√£o abaixo para testar a gera√ß√£o de PDF independente:</p>
        </div>

        <button onclick="exportToPDF()" class="mt-10 export-btn bg-red-800 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-3">
            <i class="fas fa-file-pdf"></i> Exportar para PDF
        </button>
    </div>

    <script>
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('content-to-export');
            
            // Captura o elemento como imagem
            const canvas = await html2canvas(element, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save('${modName}.pdf');
        }
    <\/script>
</body>
</html>`;
    }

    /**
     * INSIGHTS
     */
    function startInsights() {
        if (insightTimer) clearInterval(insightTimer);
        showRandomInsight();
        insightTimer = setInterval(showRandomInsight, 15000);
    }

    function closeInsights() {
        const bubble = document.getElementById('insight-bubble');
        if (insightTimer) { clearInterval(insightTimer); insightTimer = null; }
        bubble.classList.add('hiding');
        setTimeout(() => { bubble.classList.remove('visible', 'hiding'); }, 500);
    }

    function showRandomInsight() {
        const bubble = document.getElementById('insight-bubble');
        if (bubble.classList.contains('visible')) {
            bubble.classList.add('hiding');
            setTimeout(() => { bubble.classList.remove('visible', 'hiding'); updateInsight(); }, 500);
        } else { updateInsight(); }
    }

    function updateInsight() {
        const bubble = document.getElementById('insight-bubble');
        const insight = complianceInsights[Math.floor(Math.random() * complianceInsights.length)];
        document.getElementById('insight-cat').innerText = insight.cat;
        document.getElementById('insight-content').innerText = insight.text;
        bubble.classList.add('visible');
    }

    function showNotification(msg) {
        const n = document.getElementById('notification');
        n.innerText = msg; n.style.display = 'block';
        setTimeout(() => { n.style.display = 'none'; }, 3000);
    }

    function showEmptyState() {
        document.getElementById('empty-state').style.display = 'flex';
        document.getElementById('code-editor').style.display = 'none';
        document.getElementById('preview-frame').style.display = 'none';
    }
</script>
</body>
</html>
